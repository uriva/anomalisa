<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>anomalisa</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }
    .container { max-width: 640px; margin: 0 auto; padding: 2rem 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 1.5rem; color: #fff; }
    h2 { font-size: 1.1rem; margin-bottom: 1rem; color: #ccc; }
    input, button { font-family: inherit; font-size: 0.9rem; }
    input { background: #1a1a1a; border: 1px solid #333; color: #e0e0e0; padding: 0.5rem 0.75rem; border-radius: 4px; width: 100%; }
    input:focus { outline: none; border-color: #666; }
    button { background: #fff; color: #0a0a0a; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; }
    button:hover { background: #ddd; }
    button.danger { background: #c0392b; color: #fff; }
    button.danger:hover { background: #a93226; }
    button.secondary { background: #333; color: #e0e0e0; }
    button.secondary:hover { background: #444; }
    .card { background: #141414; border: 1px solid #222; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .token { font-family: monospace; font-size: 0.8rem; background: #1a1a1a; padding: 0.25rem 0.5rem; border-radius: 3px; word-break: break-all; }
    .row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .row input { flex: 1; }
    .section { margin-bottom: 2rem; }
    .anomaly-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .anomaly-table th, .anomaly-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid #222; text-align: left; }
    .anomaly-table th { color: #888; font-weight: 500; }
    .muted { color: #666; font-size: 0.85rem; }
    .status { padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; }
    .logout { position: absolute; top: 1rem; right: 1rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    #app { position: relative; }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script type="module">
    import { init, id } from "https://esm.sh/@instantdb/core@0.22.135";

    const app = document.getElementById("app");

    const configRes = await fetch("/config");
    const { instantdbAppId } = await configRes.json();

    const db = init({ appId: instantdbAppId });

    const render = (html) => { app.innerHTML = html; };

    const renderLoading = () => render("<p class='muted'>Loading...</p>");

    const renderLogin = () => {
      render(`
        <h1>anomalisa</h1>
        <div class="card">
          <div class="section">
            <h2>Sign in</h2>
            <div class="row">
              <input id="email" type="email" placeholder="you@example.com" />
              <button id="send-code">Send code</button>
            </div>
          </div>
          <div class="section" id="code-section" style="display:none">
            <div class="row">
              <input id="code" type="text" placeholder="Enter code" />
              <button id="verify-code">Verify</button>
            </div>
          </div>
          <p class="muted" id="login-msg"></p>
        </div>
      `);

      let sentEmail = "";

      document.getElementById("send-code").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        if (!email) return;
        sentEmail = email;
        try {
          await db.auth.sendMagicCode({ email });
          document.getElementById("code-section").style.display = "block";
          document.getElementById("login-msg").textContent = "Code sent to " + email;
        } catch (e) {
          document.getElementById("login-msg").textContent = e.message;
        }
      });

      document.getElementById("verify-code").addEventListener("click", async () => {
        const code = document.getElementById("code").value.trim();
        if (!code) return;
        try {
          await db.auth.signInWithMagicCode({ email: sentEmail, code });
        } catch (e) {
          document.getElementById("login-msg").textContent = e.message;
        }
      });
    };

    const fetchAnomalies = async (token) => {
      try {
        const res = await fetch(location.origin, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ endpoint: "getAnomalies", payload: { token } }),
        });
        return await res.json();
      } catch {
        return { anomalies: [] };
      }
    };

    const renderDashboard = (user) => {
      render(`
        <div class="header">
          <h1>anomalisa</h1>
          <button class="secondary" id="logout">Sign out</button>
        </div>
        <p class="muted" style="margin-bottom:1.5rem">${user.email}</p>

        <div class="section">
          <h2>Create project</h2>
          <div class="row">
            <input id="project-name" placeholder="Project name" />
            <button id="create-project">Create</button>
          </div>
          <p class="muted" id="create-msg"></p>
        </div>

        <div class="section">
          <h2>Projects</h2>
          <div id="projects-list"><p class="muted">Loading...</p></div>
        </div>

        <div class="section" id="anomalies-section" style="display:none">
          <h2>Anomalies</h2>
          <div id="anomalies-list"></div>
        </div>
      `);

      document.getElementById("logout").addEventListener("click", () => db.auth.signOut());

      document.getElementById("create-project").addEventListener("click", async () => {
        const name = document.getElementById("project-name").value.trim();
        if (!name) return;
        const projectId = id();
        const token = crypto.randomUUID();
        try {
          await db.transact([
            db.tx.projects[projectId].update({ name, token }).link({ owner: user.id }),
          ]);
          document.getElementById("project-name").value = "";
          document.getElementById("create-msg").textContent = "Created!";
          setTimeout(() => { document.getElementById("create-msg").textContent = ""; }, 2000);
        } catch (e) {
          document.getElementById("create-msg").textContent = e.message;
        }
      });

      db.subscribeQuery({ projects: { $: { where: { "owner.id": user.id } } } }, (resp) => {
        if (resp.error) {
          document.getElementById("projects-list").innerHTML = `<p class="muted">${resp.error.message}</p>`;
          return;
        }
        const projects = resp.data?.projects ?? [];
        if (projects.length === 0) {
          document.getElementById("projects-list").innerHTML = "<p class='muted'>No projects yet.</p>";
          return;
        }
        document.getElementById("projects-list").innerHTML = projects.map((p) => `
          <div class="card" data-project-id="${p.id}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
              <strong>${p.name}</strong>
              <div style="display:flex;gap:0.25rem">
                <button class="secondary view-anomalies" data-token="${p.token}">Anomalies</button>
                <button class="danger delete-project" data-id="${p.id}">Delete</button>
              </div>
            </div>
            <div><span class="muted">Token:</span> <span class="token">${p.token}</span></div>
          </div>
        `).join("");

        document.querySelectorAll(".delete-project").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (!confirm("Delete this project?")) return;
            await db.transact([db.tx.projects[btn.dataset.id].delete()]);
          });
        });

        document.querySelectorAll(".view-anomalies").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const section = document.getElementById("anomalies-section");
            const list = document.getElementById("anomalies-list");
            section.style.display = "block";
            list.innerHTML = "<p class='muted'>Loading...</p>";
            const result = await fetchAnomalies(btn.dataset.token);
            const anomalies = result.anomalies ?? [];
            if (anomalies.length === 0) {
              list.innerHTML = "<p class='muted'>No anomalies detected.</p>";
              return;
            }
            const metricLabel = (m) => m === "userSpike" ? "User Spike" : "Total Count";
            list.innerHTML = `
              <table class="anomaly-table">
                <tr><th>Type</th><th>Event</th><th>User</th><th>Bucket</th><th>Expected</th><th>Actual</th><th>Z</th><th>Detected</th></tr>
                ${anomalies.map((a) => `
                  <tr>
                    <td>${metricLabel(a.metric)}</td>
                    <td>${a.eventName}</td>
                    <td>${a.userId ?? "-"}</td>
                    <td>${a.bucket}</td>
                    <td>${a.expected}</td>
                    <td>${a.actual}</td>
                    <td>${a.zScore}</td>
                    <td>${new Date(a.detectedAt).toLocaleString()}</td>
                  </tr>
                `).join("")}
              </table>
            `;
          });
        });
      });
    };

    renderLoading();

    db.subscribeAuth((auth) => {
      if (auth.user) {
        renderDashboard(auth.user);
      } else {
        renderLogin();
      }
    });
  </script>
</body>
</html>
